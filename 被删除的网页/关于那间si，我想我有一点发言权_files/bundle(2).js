!function(){"use strict";window.Do=window.Do||function(e){"function"==typeof e&&setTimeout(e,0)},Do.add_js=function(e){var t=document.createElement("script");t.src=e,document.getElementsByTagName("head")[0].appendChild(t)},Do.add_css=function(e,t){var n=document.createElement("link");n.rel="stylesheet",n.href=e,document.getElementsByTagName("head")[0].appendChild(n)},Do.check_js=function e(t,n){var i=t();i?n(i):setTimeout(function(){e(t,n)},33)},Do(function(){var e=$("#db-nav-sns"),t=$("#inp-query"),n=t.closest(".nav-search").find("label");"placeholder"in t[0]?(n.hide(),t.attr("placeholder",n.text())):(""!==t.val()&&n.hide(),t.parent().click(function(){t.focus(),n.hide()}).end().focusin(function(){n.hide()}).focusout(function(){""===$.trim(this.value)?n.show():n.hide()}).keydown(function(){n.hide()})),t.parents("form").submit(function(){if(!$.trim(t.val()).length)return!1}),e.find(".lnk-more, .lnk-account").click(function(e){e.preventDefault();var t,n=$(this),i=n.hasClass("lnk-more")?$("#db-productions"):$("#db-usr-setting");i.data("init")||(t=n.offset(),i.css({"margin-left":t.left-$(window).width()/2-i.width()+n.width()+parseInt(n.css("padding-right"),10)+"px",left:"50%",top:t.top+n.height()+"px"}),i.data("init",1),i.hide(),$("body").click(function(e){var t=$(e.target);t.hasClass("lnk-more")||t.hasClass("lnk-account")||t.closest("#db-usr-setting").length||t.closest("#db-productions").length||i.hide()})),"none"===i.css("display")?($(".dropdown").hide(),i.show()):$(".dropdown").hide()})});var e=function(){var e={},t=function(){};return t.prototype={otag:"{{",ctag:"}}",pragmas:{},buffer:[],pragmas_implemented:{"IMPLICIT-ITERATOR":!0},context:{},render:function(e,t,n,i){if(i||(this.context=t,this.buffer=[]),!this.includes("",e))return i?e:void this.send(e);e=this.render_pragmas(e);var r=this.render_section(e,t,n);if(!1===r&&(r=this.render_tags(e,t,n,i)),i)return r;this.sendLines(r)},send:function(e){""!==e&&this.buffer.push(e)},sendLines:function(e){if(e)for(var t=e.split("\n"),n=0;n<t.length;n++)this.send(t[n])},render_pragmas:function(e){if(!this.includes("%",e))return e;var t=this,n=this.getCachedRegex("render_pragmas",function(e,t){return new RegExp(e+"%([\\w-]+) ?([\\w]+=[\\w]+)?"+t,"g")});return e.replace(n,function(e,n,i){if(!t.pragmas_implemented[n])throw{message:"This implementation of mustache doesn't understand the '"+n+"' pragma"};if(t.pragmas[n]={},i){var r=i.split("=");t.pragmas[n][r[0]]=r[1]}return""})},render_partial:function(e,t,n){if(e=this.trim(e),!n||void 0===n[e])throw{message:"unknown_partial '"+e+"'"};return"object"!=typeof t[e]?this.render(n[e],t,n,!0):this.render(n[e],t[e],n,!0)},render_section:function(e,t,n){if(!this.includes("#",e)&&!this.includes("^",e))return!1;var i=this,r=this.getCachedRegex("render_section",function(e,t){return new RegExp("^([\\s\\S]*?)"+e+"(\\^|\\#)\\s*(.+)\\s*"+t+"\n*([\\s\\S]*?)"+e+"\\/\\s*\\3\\s*"+t+"\\s*([\\s\\S]*)$","g")});return e.replace(r,function(e,r,a,o,s,u){var c,l=r?i.render_tags(r,t,n,!0):"",d=u?i.render(u,t,n,!0):"",h=i.find(o,t);return"^"===a?c=!h||i.is_array(h)&&0===h.length?i.render(s,t,n,!0):"":"#"===a&&(c=i.is_array(h)?i.map(h,function(e){return i.render(s,i.create_context(e),n,!0)}).join(""):i.is_object(h)?i.render(s,i.create_context(h),n,!0):"function"==typeof h?h.call(t,s,function(e){return i.render(e,t,n,!0)}):h?i.render(s,t,n,!0):""),l+c+d})},render_tags:function(e,t,n,i){for(var r=this,a=function(){return r.getCachedRegex("render_tags",function(e,t){return new RegExp(e+"(=|!|>|\\{|%)?([^\\/#\\^]+?)\\1?"+t+"+","g")})},o=a(),s=function(e,i,s){switch(i){case"!":return"";case"=":return r.set_delimiters(s),o=a(),"";case">":return r.render_partial(s,t,n);case"{":return r.find(s,t);default:return r.escape(r.find(s,t))}},u=e.split("\n"),c=0;c<u.length;c++)u[c]=u[c].replace(o,s,this),i||this.send(u[c]);if(i)return u.join("\n")},set_delimiters:function(e){var t=e.split(" ");this.otag=this.escape_regex(t[0]),this.ctag=this.escape_regex(t[1])},escape_regex:function(e){if(!arguments.callee.sRE){var t=["/",".","*","+","?","|","(",")","[","]","{","}","\\"];arguments.callee.sRE=new RegExp("(\\"+t.join("|\\")+")","g")}return e.replace(arguments.callee.sRE,"\\$1")},find:function(e,t){function n(e){return!1===e||0===e||e}e=this.trim(e);var i;if(e.match(/([a-z_]+)\./gi)){var r=this.walk_context(e,t);n(r)&&(i=r)}else n(t[e])?i=t[e]:n(this.context[e])&&(i=this.context[e]);return"function"==typeof i?i.apply(t):void 0!==i?i:""},walk_context:function(e,t){for(var n=e.split("."),i=void 0!=t[n[0]]?t:this.context,r=i[n.shift()];void 0!=r&&n.length>0;)i=r,r=r[n.shift()];return"function"==typeof r?r.apply(i):r},includes:function(e,t){return-1!=t.indexOf(this.otag+e)},escape:function(e){return e=String(null===e?"":e),e.replace(/&(?!\w+;)|["'<>\\]/g,function(e){switch(e){case"&":return"&amp;";case'"':return"&quot;";case"'":return"&#39;";case"<":return"&lt;";case">":return"&gt;";default:return e}})},create_context:function(e){if(this.is_object(e))return e;var t=".";this.pragmas["IMPLICIT-ITERATOR"]&&(t=this.pragmas["IMPLICIT-ITERATOR"].iterator);var n={};return n[t]=e,n},is_object:function(e){return e&&"object"==typeof e},is_array:function(e){return"[object Array]"===Object.prototype.toString.call(e)},trim:function(e){return e.replace(/^\s*|\s*$/g,"")},map:function(e,t){if("function"==typeof e.map)return e.map(t);for(var n=[],i=e.length,r=0;r<i;r++)n.push(t(e[r]));return n},getCachedRegex:function(t,n){var i=e[this.otag];i||(i=e[this.otag]={});var r=i[this.ctag];r||(r=i[this.ctag]={});var a=r[t];return a||(a=r[t]=n(this.otag,this.ctag)),a}},{name:"mustache.js",version:"0.4.0-dev",to_html:function(e,n,i,r){var a=new t;if(r&&(a.send=r),a.render(e,n||{},i),!r)return a.buffer.join("\n")}}}();window.Mustache=e,Do(function(){Array.prototype.indexOf=Array.prototype.indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(this[t]===e)return t;return-1},String.prototype.lastChar=function(){return this.charAt(this.length-1)},function(e){function t(e){return e.replace(l,"")}function n(t){n=null;var i={position:"absolute",left:-9999,width:t.width()+"px","font-family":t.css("font-family"),"font-size":t.css("font-size"),"word-wrap":"break-word",border:"1px"};o=e("<pre></pre>").css(i).appendTo("body")}function i(e,t){var n=this;return n.elem=e,n.options=t,n.tagged={},n.init(t),n}function r(e,t){e&&s.html(e),s.css(t).show()}function a(){s.hide()}var o,s,u=0,c=e(document.body),l=/<(\/|\\\/)?b>/g,d=/(\\|\+|\:|\*|\/|\||\$|\?|\^|\[|\]|\(|\)|\.)/g,h=e.browser.version<7?"&nbsp;":"x",f=e.browser.msie&&e.browser.version<9,g={highlight:function(t,n,i){i=i||"@";var r=[];for(var a in t)r.push([a,t[a].uid]);return r.sort(function(e,t){return e[0].length<t[0].length}),e.each(r,function(e,t){var r=t[0],a=t[1];f&&(r=r.replace(/ /g,"&nbsp;")),n=n.replace(new RegExp(i+r.replace(d,"\\$1"),"g"),'<code data-id="'+a+'">'+i+r+"</code>")}),n},escape_html:function(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")},moveSelectedItem:function(t,n){var i=s.find("li"),r=i.length;r&&(n||(n=s.find(".on").index(),n+=t,n>=r&&(n-=r),n<0&&(-2===n&&(n=-1),n+=r)),i.removeClass("on"),e(i[n]).addClass("on").find("a"))},getCursorPosition:function(e){if(document.selection){var t=e.value,n=e._saved_range||document.selection.createRange(),i=e.createTextRange(),r=i.duplicate();if(r.moveToBookmark(n.getBookmark()),i.setEndPoint("EndToStart",r),null==n||null==i)return t.length;var a=n.text.replace(/[\r\n]/g,".");return t.replace(/[\r\n]/g,".").indexOf(a,i.text.length)}return e.selectionStart},setCursorPosition:function(e,t){this.selectRangeText(e,t,t)},selectRangeText:function(e,t,n){if(document.selection){var i=e.createTextRange();i.moveEnd("character",-e.value.length),i.moveEnd("character",n),i.moveStart("character",t),i.select()}else e.focus(),e.setSelectionRange(t,n)}};i.prototype={on:function(e,t){var n=this;e+=n.uuid,n.node.bind(e,function(e,i){i=[e].concat(i),t.apply(n,i)})},emit:function(e){var t=arguments,n=Array.prototype.slice.call(t,1);e+=this.uuid,this.node.trigger(e,n)},init:function(t){u++;var n=this;n.url=t.url,t.max&&(n.url=n.url.replace("{max}",t.max));var i=n.elem,r=e(i),a=!0;n.uuid=e.uuid++,n.node=r,r.bind("keyup input propertychange",function(e){if("propertychange"!=e.type||"value"===e.originalEvent.propertyName){var t=this;if(t._closed)return n.clearHighligher();var i=!e.keyCode;if(i&&!t._from_change)return void(t._from_change=!0);t._from_change=!!i;var r=n._slices=n.slices(),o=r[0],c=r[4],l=o.indexOf(n.options.leadChar)<0,d=l&&n._highlighted||!l&&a;if(c<o.length+1&&d&&n.updateHighlight(),!l&&(i||[38,40,13,16,9,27].indexOf(e.keyCode)<0)&&(n.options.delay?(n.clearTimeout(),n._t_query=setTimeout(function(){r=n._slices=n.slices(),n.query(r)},n.options.delay)):n.query(r)),l?(setTimeout(function(){u||n.hideSug()},200),u--):u++,!i){var h=9===e.keyCode||13===e.keyCode,f=s&&s.find(".on"),g=f.length&&s.is(":visible");h&&g&&n.choose(f,r)}}}),r.bind("keydown",function(e){var t=e.keyCode,r=[16,17,18,20,27,33,34,35,36,37,38,39,40,144].indexOf(t)>-1;if(a=!(r||(e.ctrlKey||e.metaKey)&&65===t||e.shiftKey&&(37===t||39===t)),8==t){var o=n.slices(),s=o[2];s&&s in n.tagged&&(i.value=o[1]+o[3],--n.tagged[s].count<=0&&delete n.tagged[s],n.setCursor(o[4]-s.length-1),e.preventDefault()),n.hideSug()}}),r[0]._sug_ev_binded||(r.bind("keydown",function(e){if(s&&s.is(":visible"))switch(e.keyCode){case 27:n.hideSug(),e.preventDefault(),e.stopPropagation();break;case 38:e.preventDefault(),g.moveSelectedItem(-1);break;case 40:e.preventDefault(),g.moveSelectedItem(1);break;case 9:e.preventDefault();break;case 32:if(n.options.queryIncludingSpace)break;case 13:var t=s.find("li.on").find("a")[0];t&&!t.id&&t.href&&(e.preventDefault(),t.click())}}),r[0]._sug_ev_binded=!0)},clearTimeout:function(){try{clearTimeout(this._t_query)}catch(e){}},slices:function(){var e=this,t=e.elem,n=t.value,i=e.getCursor(),r=n.slice(0,i),a=n.slice(i),o=r.lastIndexOf(this.options.leadChar);if(o<0)return[n,r,null,a,i];if(""===this.options.leadChar){var s=!1;for(var u in this.options.hideChar)n.indexOf(this.options.hideChar[u])>-1&&(s=!0);return s?[n,r,"",a,i]:[n,r,r,a,i]}return[n,r.slice(0,o),r.slice(o+1),a,i]},getCursor:function(){return g.getCursorPosition(this.elem)},setCursor:function(e){return g.setCursorPosition(this.elem,e)},updateHighlight:function(){var t=this;if(t.options.highlight){var n=t.elem,i=g.escape_html(n.value);f&&(i=i.replace(/ /g,h));var r=g.highlight(t.tagged,i,t.options.leadChar);t._highlighted=r!=i;var a=e(t.options.highlighter);a.html(r),a.css("marginTop",-n.scrollTop)}},cleanVal:function(e){var t,n=e||"",i=this.tagged,r=[];for(t in i)r.push(t.replace(d,"\\$1"));return r.length?(r.sort(function(e,t){return e.length<t.length}),r=r.join("|"),n=n.replace(new RegExp("@("+r+")","g"),function(e,t){return"@"+i[t].uid})):n},choose:function(n,i){var r=this;r.hideSug();var a=r.elem;a.value;n||(n=s.find(".on")),i||(i=r._slices||r.slices());var o=i[2]||"",u=t(n.attr("data-id")||n.attr("id"));if(u){var c=u;r.options.useUid||(c=e.trim(n.find(".username").text()),(c.indexOf(r.options.leadChar)>-1||s.text().split(c+"(").length>3)&&(c=u)),r.emit("choose",c,u);var l,d=this.tagged;(l=d[c])?l.count++:d[c]={uid:t(u),count:1},a.value=i[1]+r.options.leadChar+c+" "+i[3];var h=i[4]-o.length+c.length+1;r.setCursor(h),r.updateHighlight()}},showSug:function(e){var t=this;if(!e)return t.hideSug(),t;"_autocomplete"in t&&(t._autocomplete=t.node.attr("autocomplete")),t.node.attr("autocomplete","off");var n="string"==typeof e?'<div class="bd">'+e+"</div>":Mustache.to_html(this.options.listTmpl||"",e);return s.crtApi=this,t.emit("show",e),r(n,t.getSugPos()),s.find("li").hasClass("on")||s.find("li:first").addClass("on"),t},hideSug:function(){var e=this;return e.node.attr("autocomplete",e._autocomplete),e.emit("hide"),a(),e},query:function(n){var i=this,r=i.options;i.elem;n||(n=i.slices());var a=(n[0],n[2]);i._anterior_txt=n[1]+(a||"");var o=r.customData,s=(r.mode,r.max),u=(r.listTmpl,r.arrName);if(null===a||a.length>i.options.wordLimit)return i.hideSug();if(!this.options.queryIncludingSpace&&a.indexOf(" ")>-1)return i.hideSug();if(this.options.queryIncludingSpace&&""===e.trim(a))return i.hideSug();if("function"==typeof o&&(o=o()),""===a){var c=o&&o[u];return c&&c.length?i.showSug(o):i.showSug(i.options.tips)}if(o&&(o.q=a),!i.url)return i.showSug(o);i.emit("query",a),i._ajax&&i._ajax.abort(),i._ajax=e.getJSON(i.url+encodeURIComponent(a),function(n){n||(n={}),n[u]||(n[u]=[]);var o=n[u],c=o[0],l={};if(c&&(c.uid||c.id)&&e.each(o,function(e,n){var i=n.id=n.id||t(n.uid);i&&(l[i]=1)}),o.length<s&&"function"==typeof r.customData&&(o=n[u]=o.concat(r.customData(a,s-o.length,l)[u])),!o.length)return i.hideSug();i.showSug(n)})},getSugPos:function(){var t=this,i=t._anterior_txt;i=g.escape_html(i);var r=e(t.elem),a=r.offset(),s=e("<em>&nbsp;</em>"),u={};n&&n(r),f&&(i=i.replace(/ /g,h)),o.html(i).append(s),u=s.position(),t.options.alignLeft&&(u.left=0,u.top=2);var c=t.options.sugOffset;return{marginLeft:r.css("paddingLeft"),marginTop:r.css("paddingTop"),top:u.top+a.top+c.top,left:u.left+a.left+c.left}}};var p={mode:"complete",wordLimit:8,url:"https://api.douban.com/shuo/in/complete?alt=xd&count={max}&callback=?&word=",max:10,delay:200,customData:null,highlight:!1,highlighter:".tag-sug-hi",sugOffset:{top:21,left:-2},listTmpl:'<ul class="{{cls}}">{{#users}}<li data-id="{{{uid}}}"><a href="http://www.douban.com/people/{{id}}"><img src="{{{avatar}}}"><em class="username">{{{username}}}</em>({{{uid}}})</a></li>{{/users}}</ul>',arrName:"users",leadChar:"@",hideChar:[],queryIncludingSpace:!1,haltLink:!0,alignLeft:!1,tips:"@某人,&nbsp;他能收到你的消息"};e.fn.tagsug=function(t){var n=e.extend({},p,t);n.highlighter!=p.highlighter&&(n.highlight=!0);var r=this,a=[];return r.each(function(){var e=new i(this,n);a.push(e)}),r._tagsug_api=a,m&&m(),r};var m=function(){s=e("#db-tagsug-list"),s.length||(s=e('<div id="db-tagsug-list" class="suggest-overlay"></div>').appendTo(c).hide()),s.delegate("li","click",function(t){var n=s.crtApi;n&&n.choose(e(t.currentTarget))}).delegate("li","hover",function(t){e(t.currentTarget).parent().children(".on").removeClass("on").end().end().toggleClass("on")}).delegate("a","click",function(e){var t=s.crtApi;t&&t.options.haltLink&&e.preventDefault()}).click(function(e){s.hide()}),m=null};e.TagSug=i}(jQuery)}),Do(function(){var e,t,n,i=$("#inp-query,#search_text"),r={q:"",items:[{num:"",name:"日记",cat:1015},{num:"",name:"成员",cat:1005},{num:"",name:"图片",cat:1025},{num:"",name:"小站",cat:2012},{num:"",name:"电影",cat:1002},{num:"",name:"书籍",cat:1001},{num:"",name:"音乐",cat:1003},{num:"",name:"移动应用",cat:3064}],source:"suggest"};i.one("focus",function(){Do.check_js(function(){return $.fn.tagsug&&window.Mustache},function(){t=i.tagsug({wordLimit:30,url:"/j/search_suggest?q=",arrName:"items",max:null,haltLink:!1,sugOffset:{left:-6,top:26},listTmpl:'<ul class="sug-kind-search"><li class="title"><a href="javascript: void 0;">搜索 “<span>{{q}}</span>” 相关的：</a></li>{{#items}}<li><a href="/search?cat={{cat}}&q={{q}}&source={{source}}"><span>{{num}}</span>{{name}}</a></li>{{/items}}</ul>',leadChar:"",hideChar:["@"],alignLeft:!0,queryIncludingSpace:!0,tips:null})._tagsug_api[0],t.on("query",function(n,i){i!==e&&(r.q=e=i,t._anterior_txt="",t.showSug(r))}),n=i.tagsug({max:8,useUid:!0,tips:"@某人，直达其个人主页"})._tagsug_api[0],n.on("choose",function(e,t){window.location="/people/"+t+"/"})})}),$("body").click(function(e){var t=$("#db-tagsug-list");t.length&&!$.contains(t[0],e.target)&&t.hide(),$(e.target).is("#db-tagsug-list .title a")&&$(".nav-search form").submit()})})}();
